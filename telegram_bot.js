require('dotenv').config();
const express = require('express');
const TelegramBot = require('node-telegram-bot-api');

const app = express();
const port = process.env.PORT || 3000;
const token = process.env.TOKEN;

app.get('/', (req, res) => {
  res.send('Inclus√£o Digital Bot ‚Äî ativo');
});

app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

app.listen(port, () => {
  console.log(`Servidor web ativo na porta ${port}`);

  if (!token) {
    console.error('TOKEN n√£o definido em process.env.TOKEN');
    return;
  }

  const bot = new TelegramBot(token, { polling: true, filepath: false });

  const mainMenu = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'O que √© acessibilidade digital?', callback_data: 'what' }],
        [{ text: 'Como tornar um site acess√≠vel', callback_data: 'how' }],
        [{ text: 'Boas pr√°ticas r√°pidas', callback_data: 'tips' }],
        [{ text: 'Ferramentas e recursos', callback_data: 'tools' }],
        [{ text: 'Leis e direitos (Brasil)', callback_data: 'laws' }],
        [{ text: 'Por que a inclus√£o importa?', callback_data: 'why' }],
        [{ text: 'Dicas para testar acessibilidade', callback_data: 'test' }],
        [{ text: 'Saiba mais (Instagram)', callback_data: 'learn_more' }]
      ]
    },
    parse_mode: 'HTML'
  };

  bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const welcome = `<b>Ol√°!</b>\n\nSou o <b>Inclus√£o Digital Bot</b>. Escolha um t√≥pico abaixo para aprender sobre Acessibilidade Digital.`;
    bot.sendMessage(chatId, welcome, mainMenu);
  });

  bot.onText(/\/menu/, (msg) => {
    bot.sendMessage(msg.chat.id, 'Menu principal:', mainMenu);
  });

  bot.on('callback_query', async (callbackQuery) => {
    const msg = callbackQuery.message;
    const data = callbackQuery.data;
    const chatId = msg.chat.id;

    const backButton = {
      reply_markup: {
        inline_keyboard: [[{ text: 'üîô Voltar ao menu', callback_data: 'menu' }]]
      },
      parse_mode: 'HTML'
    };

    try {
      if (data === 'menu') {
        await bot.editMessageText('<b>Menu principal</b>\nEscolha um t√≥pico:', {
          chat_id: chatId,
          message_id: msg.message_id,
          reply_markup: mainMenu.reply_markup,
          parse_mode: 'HTML'
        });
        await bot.answerCallbackQuery(callbackQuery.id);
        return;
      }

      if (data === 'what') {
        const text = `<b>O que √© Acessibilidade Digital?</b>\n\nAcessibilidade digital significa projetar e construir conte√∫do, ferramentas e servi√ßos online de forma que pessoas com diferentes habilidades ‚Äî incluindo defici√™ncias visuais, auditivas, motoras ou cognitivas ‚Äî possam acessar, entender e usar a informa√ß√£o com independ√™ncia. √â sobre igualdade de acesso, n√£o apenas sobre conformidade t√©cnica.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'how') {
        const text = `<b>Como tornar um site acess√≠vel</b>\n\n1. Use marca√ß√£o sem√¢ntica (headings, listas, labels).\n2. Forne√ßa textos alternativos (alt) para imagens.\n3. Garanta navega√ß√£o por teclado.\n4. Ofere√ßa legendas e transcri√ß√µes para m√≠dias.\n5. Verifique contraste de cores e tamanhos de fonte.\n6. Teste com leitores de tela.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'tips') {
        const text = `<b>Boas pr√°ticas r√°pidas</b>\n\n‚Ä¢ N√£o dependa apenas da cor para transmitir informa√ß√£o.\n‚Ä¢ Use texto claro e objetivo.\n‚Ä¢ Crie focos vis√≠veis para navega√ß√£o por teclado.\n‚Ä¢ Evite elementos piscantes.\n‚Ä¢ Mantenha formul√°rios simples e com instru√ß√µes.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'tools') {
        const text = `<b>Ferramentas e recursos</b>\n\n‚Ä¢ NVDA ‚Äî leitor de tela (gratuito).\n‚Ä¢ WAVE ‚Äî avaliador de acessibilidade.\n‚Ä¢ Accessibility Insights ‚Äî auditoria autom√°tica.\n‚Ä¢ Contrast Checker ‚Äî testa contraste entre cores.\n‚Ä¢ Lighthouse (Chrome DevTools) ‚Äî checagem r√°pida.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'laws') {
        const text = `<b>Leis e direitos (Brasil)</b>\n\nA Lei Brasileira de Inclus√£o (Lei n¬∫ 13.146/2015) garante direitos e promove acessibilidade para pessoas com defici√™ncia. Tamb√©m h√° normas t√©cnicas (ex.: WCAG) que orientam a implementa√ß√£o. Acessibilidade digital √© tanto legal quanto √©tica.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'why') {
        const text = `<b>Por que a inclus√£o √© importante?</b>\n\nInclus√£o digital amplia oportunidades de educa√ß√£o, trabalho e participa√ß√£o social. Bons projetos acess√≠veis atendem mais pessoas, melhoram a experi√™ncia geral e demonstram responsabilidade social. √â um ganho para todos.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'test') {
        const text = `<b>Dicas para testar</b>\n\n‚Ä¢ Navegue somente com o teclado.\n‚Ä¢ Ative um leitor de tela e acompanhe a ordem l√≥gica.\n‚Ä¢ Teste contrastes e tamanhos de fonte.\n‚Ä¢ Pe√ßa pessoas reais com diferentes necessidades para testar.\n‚Ä¢ Use ferramentas de auditoria e corrija os pontos cr√≠ticos.`;
        await bot.sendMessage(chatId, text, backButton);
      } else if (data === 'learn_more') {
        const text = `<b>Saiba mais</b>\n\nSiga o @webacessibilidade no Instagram para materiais, dicas e exemplos pr√°ticos:\nhttps://www.instagram.com/webacessibilidade/\n\nSe quiser, pe√ßa aqui para receber a cartilha digital ou agendar uma oficina.`;
        const moreButtons = {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'Abrir Instagram', url: 'https://www.instagram.com/webacessibilidade/' }],
              [{ text: 'Receber cartilha (PDF)', callback_data: 'get_pdf' }],
              [{ text: 'üîô Voltar ao menu', callback_data: 'menu' }]
            ]
          },
          parse_mode: 'HTML'
        };
        await bot.sendMessage(chatId, text, moreButtons);
      } else if (data === 'get_pdf') {
        await bot.sendMessage(chatId, 'Envie aqui o seu e-mail ou digite "link" para receber o link p√∫blico da cartilha.');
      } else {
        await bot.sendMessage(chatId, 'Op√ß√£o desconhecida. Volte ao menu usando o bot√£o.', backButton);
      }

      await bot.answerCallbackQuery(callbackQuery.id);
    } catch (err) {
      console.error('callback_query error', err);
      try {
        await bot.answerCallbackQuery(callbackQuery.id, { text: 'Ocorreu um erro. Tente novamente.' });
      } catch (e) {}
    }
  });

  bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = String(msg.text || '').trim();

    if (text.toLowerCase() === 'link') {
      await bot.sendMessage(chatId, 'Aqui est√° o link p√∫blico para a cartilha: https://inclusao-digital-bot.onrender.com/cartilha.pdf');
      return;
    }

    if (text.includes('@')) {
      await bot.sendMessage(chatId, 'Obrigado! Recebemos seu contato. Em breve enviaremos a cartilha por e-mail (simula√ß√£o).', {
        reply_markup: {
          inline_keyboard: [[{ text: 'üîô Voltar ao menu', callback_data: 'menu' }]]
        }
      });
      return;
    }

    if (text.startsWith('/')) {
      await bot.sendMessage(chatId, 'Comando n√£o reconhecido. Use /start para abrir o menu ou /menu.', {
        reply_markup: {
          inline_keyboard: [[{ text: 'üîô Voltar ao menu', callback_data: 'menu' }]]
        }
      });
      return;
    }

    await bot.sendMessage(chatId, 'Use o menu para navegar pelos assuntos. Se quiser o menu novamente, envie /menu.', mainMenu);
  });

  bot.on('polling_error', (error) => {
    console.error('polling_error', error);
  });

  process.on('unhandledRejection', (reason) => {
    console.error('unhandledRejection', reason);
  });

  process.on('uncaughtException', (err) => {
    console.error('uncaughtException', err);
    process.exit(1);
  });
});
